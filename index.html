<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Career Discovery AI</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  /* â”€â”€â”€ RESET & BASE â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:         #f4f5f9;
    --surface:    #ffffff;
    --border:     #e8eaf0;
    --border2:    #ececf1;
    --text-main:  #1a1d2e;
    --text-sub:   #6b7280;
    --text-light: #9ca3af;
    --accent:     #5b8cff;
    --accent2:    #a78bfa;
    --green:      #34d399;
    --pink:       #f472b6;
    --orange:     #fb923c;
    --ai-bubble:  #f0f1f7;
    --user-bubble:#e9efff;
    --shadow-sm:  0 1px 3px rgba(0,0,0,.06);
    --shadow-md:  0 4px 16px rgba(0,0,0,.08);
    --shadow-lg:  0 8px 32px rgba(0,0,0,.10);
    --radius-sm:  8px;
    --radius-md:  14px;
    --radius-lg:  20px;
    --font:       'DM Sans', sans-serif;
  }

  html, body { height: 100%; font-family: var(--font); background: var(--bg); color: var(--text-main); font-size: 14px; line-height: 1.55; -webkit-font-smoothing: antialiased; }

  /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
  .app-shell { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* â”€â”€â”€ TOPBAR â”€â”€â”€ */
  .topbar { display: flex; align-items: center; gap: 10px; padding: 0 20px; height: 52px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 10; }
  .topbar-logo { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 15px; color: var(--text-main); text-decoration: none; }
  .topbar-logo .logo-mark { width: 22px; height: 22px; border-radius: 6px; background: linear-gradient(135deg, #5b8cff, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 11px; color: #fff; font-weight: 700; }
  .topbar-logo .logo-text { color: var(--text-main); }
  .topbar-logo .logo-text span { color: #5b8cff; }
  .topbar-divider { color: var(--border); margin: 0 2px; font-size: 18px; }
  .topbar-title { font-weight: 600; font-size: 14px; color: var(--text-main); white-space: nowrap; }
  .breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-sub); min-width: 0; flex: 1; }
  .breadcrumb svg { width: 14px; height: 14px; opacity: .5; flex-shrink: 0; }
  .breadcrumb .crumb { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .word-badge { display: inline-flex; align-items: center; gap: 4px; background: #fff0f6; color: #db2777; border: 1px solid #fce7f3; border-radius: 20px; font-size: 11px; font-weight: 600; padding: 3px 10px; flex-shrink: 0; }
  .word-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #f472b6; }
  .topbar-actions { display: flex; align-items: center; gap: 8px; margin-left: auto; }
  .icon-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-sub); transition: all .18s; }
  .icon-btn:hover { background: var(--bg); border-color: var(--accent); color: var(--accent); }
  .icon-btn svg { width: 15px; height: 15px; }
  .avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #5b8cff, #a78bfa); font-size: 12px; font-weight: 600; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }

  /* â”€â”€â”€ STATUS BAR â”€â”€â”€ */
  .status-bar { display: flex; align-items: center; gap: 8px; padding: 5px 20px; background: #f9fafb; border-bottom: 1px solid var(--border); font-size: 11.5px; color: var(--text-sub); flex-shrink: 0; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #d1d5db; flex-shrink: 0; }
  .status-dot.ok { background: var(--green); animation: pulse-dot 2s ease-in-out infinite; }
  .status-dot.error { background: #f87171; }
  .status-dot.loading { background: var(--orange); animation: pulse-dot 1s ease-in-out infinite; }
  .status-sep { color: var(--border); }

  /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
  .main-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 16px 20px; gap: 12px; }

  /* â”€â”€â”€ INSTRUCTIONS BANNER â”€â”€â”€ */
  .instructions-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 18px; flex-shrink: 0; box-shadow: var(--shadow-sm); }
  .instructions-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .instructions-title { font-weight: 600; font-size: 13.5px; color: var(--text-main); }
  .listen-btn { display: flex; align-items: center; gap: 6px; background: #f9fafb; border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-size: 12px; font-weight: 500; color: var(--text-sub); cursor: pointer; transition: all .18s; }
  .listen-btn:hover { border-color: var(--accent); color: var(--accent); background: #f0f4ff; }
  .listen-btn svg { width: 13px; height: 13px; }
  .instructions-list { list-style: none; display: flex; flex-direction: column; gap: 4px; }
  .instructions-list li { font-size: 12.5px; color: var(--text-sub); display: flex; gap: 8px; }
  .instructions-list li span.num { color: var(--text-light); font-size: 11px; min-width: 14px; }
  .read-more { display: inline-flex; align-items: center; gap: 4px; font-size: 11.5px; color: var(--accent); cursor: pointer; margin-top: 6px; font-weight: 500; }
  .read-more svg { width: 12px; height: 12px; }

  /* â”€â”€â”€ PANEL WRAPPER â”€â”€â”€ */
  .panel-wrapper { flex: 1; overflow: hidden; display: flex; gap: 12px; min-height: 0; }

  /* â”€â”€â”€ CONVERSATION CARD â”€â”€â”€ */
  .conv-card { flex: 1; min-width: 0; background: var(--surface); border-radius: var(--radius-lg); border: 1.5px solid transparent; background-clip: padding-box; box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden; position: relative; }
  .conv-card::before { content: ''; position: absolute; inset: -1.5px; border-radius: calc(var(--radius-lg) + 1.5px); background: linear-gradient(135deg, #5b8cff33 0%, #a78bfa33 50%, #34d39933 100%); z-index: 0; pointer-events: none; }
  .conv-inner { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100%; background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; }
  .conv-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border2); flex-shrink: 0; }
  .conv-title { font-weight: 600; font-size: 13.5px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
  .conv-phase-badge { background: linear-gradient(135deg, #ede9fe, #dbeafe); color: #5b21b6; font-size: 10.5px; font-weight: 600; padding: 2px 9px; border-radius: 20px; letter-spacing: .2px; }
  .conv-meta { display: flex; align-items: center; gap: 6px; font-size: 11.5px; color: var(--text-sub); }
  .conv-meta svg { width: 13px; height: 13px; }

  /* MESSAGES AREA */
  .messages-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
  .messages-area::-webkit-scrollbar { width: 4px; }
  .messages-area::-webkit-scrollbar-track { background: transparent; }
  .messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .msg-row { display: flex; gap: 10px; align-items: flex-start; }
  .msg-row.user { flex-direction: row-reverse; }
  .ai-avatar-ring { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; }
  .ai-avatar-ring::before { content: ''; position: absolute; inset: -2px; border-radius: 50%; background: conic-gradient(#5b8cff 0deg,#a78bfa 90deg,#f472b6 180deg,#fb923c 270deg,#34d399 320deg,#5b8cff 360deg); animation: spin-slow 4s linear infinite; z-index: 0; }
  .ai-avatar-ring-inner { position: relative; z-index: 1; width: 26px; height: 26px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; }
  .ai-avatar-ring-inner svg { width: 12px; height: 12px; color: var(--accent); }
  @keyframes spin-slow { to { transform: rotate(360deg); } }
  .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .bubble { max-width: 78%; padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.6; position: relative; }
  .bubble.ai { background: var(--ai-bubble); border-top-left-radius: 4px; color: var(--text-main); animation: pop-in .28s cubic-bezier(.34,1.56,.64,1) both; }
  .bubble.user { background: var(--user-bubble); border-top-right-radius: 4px; color: var(--text-main); animation: pop-in .28s cubic-bezier(.34,1.56,.64,1) both; }
  @keyframes pop-in { from { opacity: 0; transform: scale(.9) translateY(6px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  .question-label { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
  .question-label .q-num { font-size: 11px; font-weight: 700; color: var(--accent); background: #e9efff; padding: 1px 7px; border-radius: 10px; }
  .question-label .q-title { font-size: 11px; font-weight: 600; color: var(--text-sub); }

  /* typing indicator */
  .typing-bubble { display: flex; align-items: center; gap: 4px; padding: 12px 16px; background: var(--ai-bubble); border-radius: 16px; border-top-left-radius: 4px; width: fit-content; }
  .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-light); animation: bounce 1.2s ease-in-out infinite; }
  .typing-dot:nth-child(2) { animation-delay: .2s; }
  .typing-dot:nth-child(3) { animation-delay: .4s; }
  @keyframes bounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }

  /* INPUT AREA */
  .input-area { padding: 12px 14px; border-top: 1px solid var(--border2); display: flex; align-items: center; gap: 10px; flex-shrink: 0; background: var(--surface); }
  .text-input { flex: 1; border: 1.5px solid var(--border); border-radius: 24px; padding: 9px 16px; font-family: var(--font); font-size: 13px; color: var(--text-main); background: var(--bg); outline: none; transition: border-color .18s; resize: none; height: 40px; line-height: 1.4; }
  .text-input:focus { border-color: var(--accent); background: #fff; }
  .text-input::placeholder { color: var(--text-light); }
  .text-input:disabled { opacity: .6; cursor: not-allowed; }

  /* SEND BUTTON */
  .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .18s; flex-shrink: 0; }
  .send-btn:hover { background: #3f72f0; transform: scale(1.06); }
  .send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  .send-btn svg { width: 15px; height: 15px; color: #fff; }

  /* MIC BUTTON */
  .mic-btn-wrap { position: relative; width: 40px; height: 40px; cursor: pointer; flex-shrink: 0; }
  .mic-btn-ring { position: absolute; inset: -4px; border-radius: 50%; background: conic-gradient(#5b8cff 0deg,#a78bfa 60deg,#f472b6 120deg,#fb923c 180deg,#facc15 220deg,#34d399 280deg,#22d3ee 320deg,#5b8cff 360deg); filter: blur(3px); animation: spin-slow 3s linear infinite; opacity: .85; }
  .mic-btn-core { position: relative; z-index: 1; width: 100%; height: 100%; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform .18s; }
  .mic-btn-core:hover { transform: scale(1.06); }
  .mic-btn-core svg { width: 17px; height: 17px; color: var(--accent); }
  .mic-btn-wrap.listening .mic-btn-ring { animation: spin-slow 1.2s linear infinite; opacity: 1; filter: blur(4px); }
  .mic-btn-wrap.listening .mic-btn-core { background: #f0f4ff; }
  .mic-btn-wrap.recording .mic-btn-ring { opacity: 1; filter: blur(5px); }
  .mic-btn-wrap.recording .mic-btn-core { background: #fff0f6; }
  .mic-btn-wrap.recording .mic-btn-core svg { color: var(--pink); }
  .mic-btn-wrap:disabled { opacity: .5; cursor: not-allowed; }

  /* â”€â”€â”€ NOTES PANEL â”€â”€â”€ */
  .notes-panel { width: 260px; flex-shrink: 0; background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden; }
  .notes-header { padding: 12px 14px; border-bottom: 1px solid var(--border2); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .notes-title { font-weight: 600; font-size: 12.5px; color: var(--text-main); display: flex; align-items: center; gap: 7px; }
  .notes-title .icon-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse-dot 2s ease-in-out infinite; }
  @keyframes pulse-dot { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: .5; transform: scale(1.3); } }
  .notes-scroll { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
  .notes-scroll::-webkit-scrollbar { width: 3px; }
  .notes-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .note-card { background: #f9fafc; border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 10px 12px; animation: slide-in .3s ease both; }
  @keyframes slide-in { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
  .note-phase { display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: var(--accent); margin-bottom: 5px; }
  .note-phase-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }
  .note-label { font-size: 11.5px; font-weight: 600; color: var(--text-main); margin-bottom: 3px; }
  .note-value { font-size: 11.5px; color: var(--text-sub); line-height: 1.5; }
  .note-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
  .note-tag { background: #ede9fe; color: #5b21b6; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
  .note-tag.green { background: #d1fae5; color: #065f46; }
  .note-tag.pink { background: #fce7f3; color: #9d174d; }
  .note-tag.orange { background: #ffedd5; color: #9a3412; }
  .note-tag.blue { background: #dbeafe; color: #1e40af; }
  .strength-bar-row { display: flex; align-items: center; gap: 7px; margin-top: 5px; }
  .strength-label { font-size: 10.5px; color: var(--text-sub); min-width: 70px; }
  .strength-track { flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .strength-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #5b8cff, #a78bfa); transition: width .6s ease; }

  /* â”€â”€â”€ BOTTOM ACTION BAR â”€â”€â”€ */
  .action-bar { display: flex; align-items: center; justify-content: flex-end; padding: 10px 20px; flex-shrink: 0; background: transparent; }
  .cta-btn { display: flex; align-items: center; gap: 8px; background: var(--accent); color: #fff; border: none; border-radius: 24px; padding: 10px 22px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; box-shadow: 0 3px 12px rgba(91,140,255,.35); }
  .cta-btn:hover { background: #3f72f0; transform: translateY(-1px); box-shadow: 0 5px 18px rgba(91,140,255,.4); }
  .cta-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
  .cta-btn svg { width: 15px; height: 15px; }

  /* â”€â”€â”€ SCREENS â”€â”€â”€ */
  .screen { display: none; }
  .screen.active { display: flex; flex-direction: column; height: 100%; }

  /* â”€â”€â”€ FORM SCREEN â”€â”€â”€ */
  .form-screen-inner { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .form-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 32px 36px; width: 100%; max-width: 480px; box-shadow: var(--shadow-lg); animation: pop-in .35s cubic-bezier(.34,1.56,.64,1) both; }
  .form-card-header { text-align: center; margin-bottom: 24px; }
  .form-logo-ring { width: 52px; height: 52px; border-radius: 50%; background: conic-gradient(#5b8cff, #a78bfa, #f472b6, #34d399, #5b8cff); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; animation: spin-slow 5s linear infinite; }
  .form-logo-inner { width: 44px; height: 44px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; }
  .form-logo-inner svg { width: 22px; height: 22px; color: var(--accent); }
  .form-card h2 { font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
  .form-card p { font-size: 13px; color: var(--text-sub); }
  .field-group { margin-bottom: 14px; }
  .field-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 5px; text-transform: uppercase; letter-spacing: .4px; }
  .field-input, .field-select, .field-textarea { width: 100%; padding: 9px 13px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-family: var(--font); font-size: 13px; color: var(--text-main); background: var(--bg); outline: none; transition: border-color .18s, box-shadow .18s; }
  .field-input:focus, .field-select:focus, .field-textarea:focus { border-color: var(--accent); background: #fff; box-shadow: 0 0 0 3px rgba(91,140,255,.12); }
  .field-textarea { resize: none; height: 72px; line-height: 1.5; }
  .field-row { display: flex; gap: 12px; }
  .field-row .field-group { flex: 1; }
  .submit-btn { width: 100%; padding: 11px; background: linear-gradient(135deg, #5b8cff, #a78bfa); color: #fff; border: none; border-radius: 24px; font-family: var(--font); font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 6px; transition: all .2s; box-shadow: 0 3px 14px rgba(91,140,255,.35); display: flex; align-items: center; justify-content: center; gap: 8px; }
  .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(91,140,255,.4); }
  .submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
  .submit-btn svg { width: 16px; height: 16px; }



  /* â”€â”€â”€ REPORT SCREEN â”€â”€â”€ */
  .report-scroll { flex: 1; overflow-y: auto; padding: 20px; }
  .report-scroll::-webkit-scrollbar { width: 5px; }
  .report-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
  .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; max-width: 900px; margin: 0 auto; }
  .report-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 18px 20px; box-shadow: var(--shadow-sm); animation: pop-in .4s cubic-bezier(.34,1.56,.64,1) both; }
  .report-card.full { grid-column: 1/-1; }
  .report-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--text-sub); margin-bottom: 10px; display: flex; align-items: center; gap: 7px; }
  .report-card-title .icon-sq { width: 20px; height: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
  .snapshot-name { font-size: 22px; font-weight: 700; color: var(--text-main); margin-bottom: 3px; }
  .snapshot-meta { font-size: 12.5px; color: var(--text-sub); margin-bottom: 12px; }
  .interest-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .interest-tag { background: linear-gradient(135deg, #ede9fe, #dbeafe); color: #3730a3; font-size: 11.5px; font-weight: 600; padding: 4px 12px; border-radius: 20px; }
  .strength-list { list-style: none; display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
  .strength-item { display: flex; align-items: center; gap: 8px; font-size: 12.5px; color: var(--text-main); }
  .strength-item::before { content: 'â–¸'; color: var(--accent); font-size: 11px; }
  .career-path-card { border-radius: var(--radius-md); border: 1.5px solid var(--border); overflow: hidden; margin-top: 8px; background: var(--surface); }
  .career-path-header { padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; }
  .career-path-title { font-size: 14px; font-weight: 700; color: var(--text-main); }
  .career-cluster { font-size: 10.5px; font-weight: 600; padding: 3px 10px; border-radius: 20px; background: #e9efff; color: var(--accent); }
  .career-path-body { padding: 0 15px 14px; }
  .why-list { list-style: none; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
  .why-item { font-size: 12px; color: var(--text-sub); display: flex; gap: 7px; line-height: 1.5; }
  .why-bullet { color: var(--green); font-size: 12px; flex-shrink: 0; }
  .skill-chips { display: flex; flex-wrap: wrap; gap: 5px; }
  .skill-chip { background: #f4f5f9; border: 1px solid var(--border); border-radius: 6px; font-size: 10.5px; font-weight: 500; padding: 3px 9px; color: var(--text-sub); }
  .hint-list { list-style: none; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
  .hint-item { font-size: 12px; color: var(--text-sub); display: flex; gap: 6px; }
  .hint-num { background: #ffedd5; color: #9a3412; font-size: 9.5px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .report-dl-btn { display: flex; align-items: center; gap: 8px; background: var(--surface); border: 1.5px solid var(--accent); color: var(--accent); border-radius: 24px; padding: 9px 20px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; }
  .report-dl-btn:hover { background: var(--accent); color: #fff; transform: translateY(-1px); }
  .report-dl-btn:disabled { opacity: .5; cursor: not-allowed; }
  .report-dl-btn svg { width: 15px; height: 15px; }

  /* â”€â”€â”€ VOICE VISUALIZER â”€â”€â”€ */
  .voice-vis { display: flex; align-items: center; gap: 2px; height: 18px; }
  .voice-bar { width: 3px; background: linear-gradient(to top, #5b8cff, #a78bfa); border-radius: 2px; animation: bar-dance 1s ease-in-out infinite; }
  .voice-bar:nth-child(1) { height: 6px;  animation-delay: .0s; }
  .voice-bar:nth-child(2) { height: 12px; animation-delay: .1s; }
  .voice-bar:nth-child(3) { height: 18px; animation-delay: .2s; }
  .voice-bar:nth-child(4) { height: 12px; animation-delay: .3s; }
  .voice-bar:nth-child(5) { height: 6px;  animation-delay: .4s; }
  @keyframes bar-dance { 0%,100% { transform: scaleY(.4); } 50% { transform: scaleY(1); } }
  .voice-vis.hidden { display: none; }

  /* â”€â”€â”€ UTILS â”€â”€â”€ */
  .hidden { display: none !important; }
  .d-flex { display: flex; }
  .gap-8  { gap: 8px; }
  .phase-dots { display: flex; align-items: center; gap: 4px; }
  .phase-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: background .3s, transform .3s; }
  .phase-dot.done   { background: var(--green); }
  .phase-dot.active { background: var(--accent); transform: scale(1.3); }
  .timer-badge { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-sub); font-weight: 500; }
  .timer-badge svg { width: 12px; height: 12px; }

  /* â”€â”€â”€ ERROR TOAST â”€â”€â”€ */
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1f2937; color: #fff; padding: 10px 18px; border-radius: 10px; font-size: 12.5px; font-weight: 500; z-index: 9999; display: none; animation: pop-in .25s ease both; max-width: 380px; text-align: center; }
  .toast.error { background: #7f1d1d; border: 1px solid #ef4444; }
  .toast.success { background: #064e3b; border: 1px solid #34d399; }
  .toast.show { display: block; }

  /* â”€â”€â”€ LOADING OVERLAY â”€â”€â”€ */
  .report-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; padding: 60px 20px; color: var(--text-sub); font-size: 13px; grid-column: 1/-1; }
  .report-loading .spin-ring { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--border); border-top-color: var(--accent); animation: spin-slow .8s linear infinite; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” STUDENT FORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-shell screen active" id="screen-form">
  <div class="topbar">
    <a class="topbar-logo" href="#">
      <div class="logo-mark">hi</div>
      <span class="logo-text">hello<span>ivy</span></span>
    </a>
    <span class="topbar-divider">â€º</span>
    <span class="topbar-title">Career Discovery AI</span>
    <div class="topbar-actions">
      <div class="avatar">A</div>
    </div>
  </div>

  <div class="form-screen-inner">
    <div class="form-card">
      <div class="form-card-header">
        <div class="form-logo-ring">
          <div class="form-logo-inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 100 6 3 3 0 000-6zM6 8a6 6 0 0112 0M3 18a9 9 0 0118 0"/></svg>
          </div>
        </div>
        <h2>Career Discovery</h2>
        <p>Tell us about yourself to personalise your AI conversation</p>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">Full Name</label>
          <input class="field-input" type="text" id="inp-name" placeholder="e.g. Alex Chen" autocomplete="off">
        </div>
        <div class="field-group">
          <label class="field-label">Grade</label>
          <select class="field-select" id="inp-grade">
            <option value="">Selectâ€¦</option>
            <option>Grade 9</option><option>Grade 10</option>
            <option>Grade 11</option><option>Grade 12</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">Board / Curriculum</label>
        <select class="field-select" id="inp-curriculum">
          <option value="">Selectâ€¦</option>
          <option>CBSE</option><option>ICSE</option>
          <option>IB â€“ International Baccalaureate</option>
          <option>IGCSE</option><option>State Board</option><option>A-Levels</option>
        </select>
      </div>

      <div class="field-group">
        <label class="field-label">Favourite Subjects</label>
        <input class="field-input" type="text" id="inp-subjects" placeholder="e.g. Maths, Computer Science, Biology">
      </div>

      <div class="field-group">
        <label class="field-label">Interests &amp; Hobbies</label>
        <textarea class="field-textarea" id="inp-interests" placeholder="What excites you outside school? Coding, sport, art, musicâ€¦"></textarea>
      </div>

      <button class="submit-btn" id="btn-start">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg>
        Start Voice Conversation
      </button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” CONVERSATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-shell screen" id="screen-chat">
  <div class="topbar">
    <a class="topbar-logo" href="#">
      <div class="logo-mark">hi</div>
      <span class="logo-text">hello<span>ivy</span></span>
    </a>
    <span class="topbar-divider">â€º</span>
    <span class="topbar-title">Career Discovery Session</span>
    <div class="breadcrumb">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      <span class="crumb" id="bc-name">â€“</span>
    </div>
    <div class="word-badge">
      <span class="dot"></span>
      <span id="word-count">0</span> words
    </div>
    <div class="topbar-actions">
      <div class="avatar" id="chat-avatar">A</div>
    </div>
  </div>

  <!-- live status bar -->
  <div class="status-bar">
    <div class="status-dot" id="chat-status-dot"></div>
    <span id="chat-status-text">Connectingâ€¦</span>
    <span class="status-sep">Â·</span>
    <span id="chat-model-info">STT: distil-whisper/distil-large-v3 Â· : Llama-3.2-3B-Instruct Â· TTS: Kokoro-82M</span>
  </div>

  <div class="main-content">
    <div class="instructions-card">
      <div class="instructions-header">
        <span class="instructions-title">Instructions</span>
        <button class="listen-btn" id="btn-listen-instr">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/></svg>
          Listen
        </button>
      </div>
      <ul class="instructions-list">
        <li><span class="num">1.</span> This is a short, focused, voice session with Ivy AI.</li>
        <li><span class="num">2.</span> Speak using the mic button or type â€” Ivy will respond via voice and text.</li>
        <li><span class="num">3.</span> This session explores your interests &amp; strengths to recommend career paths.</li>
      </ul>
      <div class="read-more" id="read-more-toggle">Read more
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      </div>
    </div>

    <div class="panel-wrapper">
      <!-- CONVERSATION CARD -->
      <div class="conv-card">
        <div class="conv-inner">
          <div class="conv-header">
            <div class="conv-title">
              <span id="conv-title-text">Information Capture</span>
              <span class="conv-phase-badge" id="conv-phase-badge">0/6 answered</span>
            </div>
            <div class="d-flex gap-8" style="align-items:center">
              <div class="voice-vis hidden" id="voice-vis">
                <div class="voice-bar"></div><div class="voice-bar"></div>
                <div class="voice-bar"></div><div class="voice-bar"></div>
                <div class="voice-bar"></div>
              </div>
              <div class="timer-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span id="chat-timer">00:00</span>
              </div>
              <div class="phase-dots" id="phase-dots"></div>
            </div>
          </div>

          <div class="messages-area" id="messages-area"></div>

          <div class="input-area">
            <textarea class="text-input" id="chat-input" placeholder="Type your response or use the micâ€¦" rows="1"></textarea>
            <button class="send-btn" id="send-btn" title="Send">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
            <div class="mic-btn-wrap" id="mic-btn" title="Click to record, click again to stop">
              <div class="mic-btn-ring"></div>
              <div class="mic-btn-core">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NOTES PANEL -->
      <div class="notes-panel">
        <div class="notes-header">
          <div class="notes-title">
            <span class="icon-dot"></span>
            AI Notes
          </div>
          <div style="font-size:11px;color:var(--text-light);font-weight:500;" id="notes-count">0 insights</div>
        </div>
        <div class="notes-scroll" id="notes-scroll">
          <div style="text-align:center;padding:30px 10px;color:var(--text-light);font-size:12px;">Notes appear as the conversation progressesâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <div class="action-bar">
    <button class="cta-btn" id="btn-generate-report" disabled>
      Generate Full Report
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-shell screen" id="screen-report">
  <div class="topbar">
    <a class="topbar-logo" href="#">
      <div class="logo-mark">hi</div>
      <span class="logo-text">hello<span>ivy</span></span>
    </a>
    <span class="topbar-divider">â€º</span>
    <span class="topbar-title">Career Discovery Report</span>
    <div class="topbar-actions">
      <button class="report-dl-btn" id="btn-dl-pdf">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Download PDF
      </button>
      <div class="avatar" id="report-avatar">A</div>
    </div>
  </div>
  <div class="report-scroll">
    <div class="report-grid" id="report-grid"></div>
  </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let API_BASE = '';  // Set by user in the form

const PHASES = [
  { id:'welcome',     label:'Welcome',     title:'Information Capture',  badge:'Startingâ€¦' },
  { id:'interests',   label:'Interests',   title:'Exploring Interests',  badge:'1/6 answered' },
  { id:'strengths',   label:'Strengths',   title:'Discovering Strengths',badge:'2/6 answered' },
  { id:'preferences', label:'Preferences', title:'Work Preferences',     badge:'3/6 answered' },
  { id:'scenarios',   label:'Scenarios',   title:'Career Scenarios',     badge:'4/6 answered' },
  { id:'refinement',  label:'Refinement',  title:'Narrowing Down',       badge:'5/6 answered' },
  { id:'summary',     label:'Summary',     title:'Wrapping Up',          badge:'6/6 answered' },
];

const state = {
  student: {},
  phaseIdx: 0,
  messages: [],      // [{role:'user'|'assistant', content:'...'}]
  notes: [],
  timerSec: 0,
  timerHandle: null,
  wordCount: 0,
  isRecording: false,
  isSpeaking: false,
  mediaRecorder: null,
  audioChunks: [],
  currentAudio: null,
  modelsLoaded: false,
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = id => document.getElementById(id);
function escHtml(t) {
  return String(t)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function showToast(msg, type='error', duration=4000) {
  const t = $('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(t._hide);
  t._hide = setTimeout(() => { t.className = 'toast'; }, duration);
}

const screens = { form: $('screen-form'), chat: $('screen-chat'), report: $('screen-report') };
function showScreen(name) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[name].classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API CALLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function apiHealth() {
  const r = await fetch(`${API_BASE}/api/health`, { signal: AbortSignal.timeout(8000) });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function apiLLM(messages, phase) {
  const body = {
    student: {
      name:       state.student.name,
      grade:      state.student.grade,
      curriculum: state.student.curriculum,
      subjects:   state.student.subjects || '',
      interests:  state.student.interests || '',
    },
    messages,
    phase,
  };
  const r = await fetch(`${API_BASE}/api/llm`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
    signal: AbortSignal.timeout(120000),
  });
  if (!r.ok) {
    const err = await r.text();
    throw new Error(`LLM error ${r.status}: ${err}`);
  }
  return r.json();
}

async function apiSTT(blob) {
  const fd = new FormData();
  fd.append('audio', blob, 'recording.webm');
  const r = await fetch(`${API_BASE}/api/stt`, {
    method: 'POST',
    body: fd,
    signal: AbortSignal.timeout(30000),
  });
  if (!r.ok) {
    const err = await r.text();
    throw new Error(`STT error ${r.status}: ${err}`);
  }
  return r.json();
}

async function apiTTS(text) {
  const r = await fetch(`${API_BASE}/api/tts`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text }),
    signal: AbortSignal.timeout(60000),
  });
  if (!r.ok) throw new Error(`TTS error ${r.status}`);
  return r.blob();
}

async function apiReport(history) {
  const body = {
    student: {
      name:       state.student.name,
      grade:      state.student.grade,
      curriculum: state.student.curriculum,
      subjects:   state.student.subjects || '',
      interests:  state.student.interests || '',
    },
    history,
  };
  const r = await fetch(`${API_BASE}/api/report`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
    signal: AbortSignal.timeout(180000),
  });
  if (!r.ok) throw new Error(`Report error ${r.status}`);
  return r.json();
}

async function apiReportPDF(history) {
  const body = {
    student: {
      name:       state.student.name,
      grade:      state.student.grade,
      curriculum: state.student.curriculum,
      subjects:   state.student.subjects || '',
      interests:  state.student.interests || '',
    },
    history,
  };
  const r = await fetch(`${API_BASE}/api/report/pdf`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
    signal: AbortSignal.timeout(180000),
  });
  if (!r.ok) throw new Error(`PDF error ${r.status}`);
  return r.blob();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API BASE â€” paste your HF Space URL (no trailing slash)
   Format:  https://username-spacename.hf.space
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
API_BASE ='https://multilinear-overtenaciously-timmy.ngrok-free.dev/' /*'https://pravin30994-career-discovery.hf.space'/*'https://multilinear-overtenaciously-timmy.ngrok-free.dev/' ;  // â† PASTE YOUR URL HERE

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM SUBMIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('btn-start').addEventListener('click', async () => {
  const name  = $('inp-name').value.trim();
  const grade = $('inp-grade').value;
  const curr  = $('inp-curriculum').value;

  if (!name || !grade || !curr) {
    [$('inp-name'), $('inp-grade'), $('inp-curriculum')].forEach(el => {
      if (!el.value.trim()) {
        el.style.borderColor = '#f472b6';
        setTimeout(() => { el.style.borderColor = ''; }, 2000);
      }
    });
    showToast('Please fill in Name, Grade, and Curriculum.', 'error');
    return;
  }

  const btn = $('btn-start');
  btn.disabled = true;
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin-slow .8s linear infinite"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Connectingâ€¦`;

  try {
    await apiHealth();
  } catch(e) {
    showToast(`Cannot reach backend: ${e.message}`, 'error');
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg> Start Voice Conversation`;
    return;
  }

  state.student = {
    name,
    grade,
    curriculum: curr,
    subjects:   $('inp-subjects').value.trim(),
    interests:  $('inp-interests').value.trim(),
    initials:   name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(),
  };

  $('bc-name').textContent = name;
  $('chat-avatar').textContent   = state.student.initials;
  $('report-avatar').textContent = state.student.initials;
  $('avatar') && ($('avatar').textContent = state.student.initials);

  showScreen('chat');
  initChat();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initChat() {
  buildPhaseDots();
  startTimer();
  state.phaseIdx  = 0;
  state.messages  = [];
  state.notes     = [];
  state.wordCount = 0;
  $('messages-area').innerHTML = '';
  $('notes-scroll').innerHTML  = '<div style="text-align:center;padding:30px 10px;color:var(--text-light);font-size:12px;">Notes appear as the conversation progressesâ€¦</div>';
  $('word-count').textContent  = '0';
  updateChatStatus();

  // Get first AI message from backend
  askLLM('welcome');
}

function updateChatStatus() {
  const dot  = $('chat-status-dot');
  const text = $('chat-status-text');
  dot.className  = 'status-dot ok';
  text.textContent = `Connected to ${API_BASE}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer() {
  state.timerSec = 0;
  clearInterval(state.timerHandle);
  state.timerHandle = setInterval(() => {
    state.timerSec++;
    const m = String(Math.floor(state.timerSec/60)).padStart(2,'0');
    const s = String(state.timerSec%60).padStart(2,'0');
    $('chat-timer').textContent = `${m}:${s}`;
  }, 1000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE DOTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPhaseDots() {
  const wrap = $('phase-dots');
  wrap.innerHTML = '';
  PHASES.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'phase-dot';
    d.id = `dot-${i}`;
    d.title = p.label;
    wrap.appendChild(d);
  });
}

function updatePhaseDots() {
  PHASES.forEach((_,i) => {
    const d = $(`dot-${i}`);
    if (!d) return;
    d.classList.remove('done','active');
    if (i < state.phaseIdx) d.classList.add('done');
    else if (i === state.phaseIdx) d.classList.add('active');
  });
  const ph = PHASES[Math.min(state.phaseIdx, PHASES.length-1)];
  $('conv-title-text').textContent  = ph.title;
  $('conv-phase-badge').textContent = ph.badge;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LLM INTERACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function askLLM(phaseId) {
  const typingEl = showTypingIndicator();
  setInputEnabled(false);

  try {
    const resp = await apiLLM(state.messages, phaseId);
    hideTypingIndicator(typingEl);
    const aiText = resp.reply || '';

    // Add to message history
    state.messages.push({ role: 'assistant', content: aiText });

    // Show AI bubble
    renderAIBubble(aiText, state.phaseIdx);
    updatePhaseDots();

    // Extract & display insights
    if (resp.insights && Object.keys(resp.insights).length > 0) {
      addInsightNote(resp.insights, PHASES[state.phaseIdx]?.label || 'Session');
    }

    // Speak the response via TTS
    speakText(aiText);

  } catch(e) {
    hideTypingIndicator(typingEl);
    showToast(`AI response failed: ${e.message}`, 'error');
    $('chat-status-dot').className = 'status-dot error';
    $('chat-status-text').textContent = 'LLM error â€” try again';
  } finally {
    setInputEnabled(true);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TTS PLAYBACK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function speakText(text) {
  if (!text || text.length < 3) return;
  try {
    $('voice-vis').classList.remove('hidden');
    state.isSpeaking = true;

    const blob = await apiTTS(text.slice(0, 400));
    const url  = URL.createObjectURL(blob);

    if (state.currentAudio) {
      state.currentAudio.pause();
      URL.revokeObjectURL(state.currentAudio.src);
    }

    const audio = new Audio(url);
    state.currentAudio = audio;

    audio.onended = () => {
      state.isSpeaking = false;
      $('voice-vis').classList.add('hidden');
      URL.revokeObjectURL(url);
    };
    audio.onerror = () => {
      state.isSpeaking = false;
      $('voice-vis').classList.add('hidden');
    };

    await audio.play();
  } catch(e) {
    state.isSpeaking = false;
    $('voice-vis').classList.add('hidden');
    // TTS failure is non-fatal â€” the text is already displayed
    console.warn('TTS failed (non-fatal):', e.message);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STT (MICROPHONE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('mic-btn').addEventListener('click', async () => {
  if (state.isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
});

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // Stop any current TTS playback
    if (state.currentAudio) { state.currentAudio.pause(); }
    $('voice-vis').classList.add('hidden');

    state.audioChunks = [];
    const options = { mimeType: 'audio/webm' };
    const mr = MediaRecorder.isTypeSupported('audio/webm')
      ? new MediaRecorder(stream, options)
      : new MediaRecorder(stream);

    state.mediaRecorder = mr;

    mr.ondataavailable = e => {
      if (e.data.size > 0) state.audioChunks.push(e.data);
    };

    mr.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(state.audioChunks, { type: mr.mimeType || 'audio/webm' });

      $('chat-input').placeholder = 'ğŸ”„ Transcribingâ€¦';
      $('chat-input').disabled = true;

      try {
        const result = await apiSTT(blob);
        const text   = result.text || '';
        if (text.trim()) {
          $('chat-input').value = text;
          $('chat-input').placeholder = 'Type your response or use the micâ€¦';
          $('chat-input').disabled = false;
          // Auto-send after 800ms
          setTimeout(sendUserMessage, 800);
        } else {
          showToast('Could not hear anything. Please try again.', 'error');
          $('chat-input').placeholder = 'Type your response or use the micâ€¦';
          $('chat-input').disabled = false;
        }
      } catch(e) {
        showToast(`Transcription failed: ${e.message}`, 'error');
        $('chat-input').placeholder = 'Type your response or use the micâ€¦';
        $('chat-input').disabled = false;
      }
    };

    mr.start();
    state.isRecording = true;
    $('mic-btn').classList.add('recording');
    $('chat-input').placeholder = 'ğŸ™ Recordingâ€¦ click mic to stop';

  } catch(e) {
    showToast('Microphone access denied. Please allow microphone access.', 'error');
  }
}

function stopRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.stop();
  }
  state.isRecording = false;
  $('mic-btn').classList.remove('recording');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND USER MESSAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendUserMessage() {
  const input = $('chat-input');
  const text  = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';

  // Count words
  state.wordCount += text.trim().split(/\s+/).length;
  $('word-count').textContent = state.wordCount;

  // Render user bubble
  renderUserBubble(text);

  // Add to history
  state.messages.push({ role: 'user', content: text });

  // Advance phase
  state.phaseIdx = Math.min(state.phaseIdx + 1, PHASES.length - 1);

  // Enable report button after phase 3
  if (state.phaseIdx >= 3) $('btn-generate-report').disabled = false;

  // Get next AI response
  const phaseId = PHASES[state.phaseIdx]?.id || 'summary';
  await askLLM(phaseId);

  // End session after last phase
  if (state.phaseIdx >= PHASES.length - 1) {
    setTimeout(() => {
      $('btn-generate-report').disabled = false;
      showToast('Session complete! Click "Generate Full Report" for your personalised career report.', 'success', 6000);
    }, 2000);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER BUBBLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAIBubble(text, phaseIdx) {
  const area = $('messages-area');
  const row  = document.createElement('div');
  row.className = 'msg-row';

  const qLabel = phaseIdx > 0 ? `
    <div class="question-label">
      <span class="q-num">Q${phaseIdx}</span>
      <span class="q-title">${PHASES[phaseIdx]?.label || ''}</span>
    </div>` : '';

  row.innerHTML = `
    <div class="ai-avatar-ring">
      <div class="ai-avatar-ring-inner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2a3 3 0 100 6 3 3 0 000-6z"/>
          <path d="M12 12c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4z"/>
        </svg>
      </div>
    </div>
    <div class="bubble ai">${qLabel}${escHtml(text)}</div>`;

  area.appendChild(row);
  scrollChat();
}

function renderUserBubble(text) {
  const area = $('messages-area');
  const row  = document.createElement('div');
  row.className = 'msg-row user';
  row.innerHTML = `
    <div class="user-avatar">${state.student.initials}</div>
    <div class="bubble user">${escHtml(text)}</div>`;
  area.appendChild(row);
  scrollChat();
}

function showTypingIndicator() {
  const area = $('messages-area');
  const el   = document.createElement('div');
  el.className = 'msg-row';
  el.innerHTML = `
    <div class="ai-avatar-ring">
      <div class="ai-avatar-ring-inner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2a3 3 0 100 6 3 3 0 000-6z"/>
          <path d="M12 12c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4z"/>
        </svg>
      </div>
    </div>
    <div class="typing-bubble">
      <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
    </div>`;
  area.appendChild(el);
  scrollChat();
  return el;
}

function hideTypingIndicator(el) {
  if (el && el.parentNode) el.parentNode.removeChild(el);
}

function scrollChat() {
  const area = $('messages-area');
  area.scrollTop = area.scrollHeight;
}

function setInputEnabled(on) {
  $('chat-input').disabled   = !on;
  $('send-btn').disabled     = !on;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSIGHTS â†’ NOTES PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addInsightNote(insights, phaseLabel) {
  const scroll = $('notes-scroll');

  if (state.notes.length === 0) scroll.innerHTML = '';

  const lines = [];
  if (insights.work_orientation)   lines.push(`Orientation: ${insights.work_orientation.join(', ')}`);
  if (insights.lifestyle)          lines.push(`Lifestyle: ${insights.lifestyle}`);
  if (insights.interests_detected) lines.push('Interests clearly expressed');
  if (insights.strengths_detected) lines.push('Strengths mentioned');
  if (lines.length === 0) return;

  state.notes.push({ phase: phaseLabel, lines });
  $('notes-count').textContent = `${state.notes.length} insight${state.notes.length>1?'s':''}`;

  const tags = [];
  if (insights.work_orientation) insights.work_orientation.forEach(o => tags.push({ text: o, cls: 'blue' }));
  if (insights.interests_detected) tags.push({ text: 'ğŸ¯ Interests', cls: 'green' });
  if (insights.strengths_detected) tags.push({ text: 'ğŸ’ª Strengths', cls: '' });

  const card = document.createElement('div');
  card.className = 'note-card';
  card.innerHTML = `
    <div class="note-phase"><span class="note-phase-dot"></span>${phaseLabel}</div>
    <div class="note-label">AI Insight</div>
    <div class="note-value">${lines.join(' Â· ')}</div>
    ${tags.length ? `<div class="note-tags">${tags.map(t=>`<span class="note-tag ${t.cls}">${t.text}</span>`).join('')}</div>` : ''}`;
  scroll.appendChild(card);
  scroll.scrollTop = scroll.scrollHeight;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERATE REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('btn-generate-report').addEventListener('click', async () => {
  showScreen('report');
  const grid = $('report-grid');
  grid.innerHTML = `<div class="report-loading"><div class="spin-ring"></div><span>Generating your personalised career reportâ€¦</span></div>`;

  try {
    const data = await apiReport(state.messages);
    const rpt  = data.report;
    renderReport(rpt, data.student || state.student);
  } catch(e) {
    grid.innerHTML = `<div class="report-loading" style="grid-column:1/-1">
      <span style="color:#f87171">âš  Report generation failed: ${escHtml(e.message)}</span>
      <button onclick="showScreen('chat')" style="margin-top:12px;padding:8px 18px;background:var(--accent);color:#fff;border:none;border-radius:20px;cursor:pointer;font-size:13px;">â† Back to Chat</button>
    </div>`;
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderReport(rpt, stu) {
  const grid = $('report-grid');
  grid.innerHTML = '';

  // Snapshot
  const snap = document.createElement('div');
  snap.className = 'report-card';
  snap.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#e9efff">ğŸ‘¤</div>Student Snapshot</div>
    <div class="snapshot-name">${escHtml(stu.name)}</div>
    <div class="snapshot-meta">${escHtml(stu.grade)} Â· ${escHtml(stu.curriculum)}</div>
    <div style="font-size:11.5px;font-weight:600;color:var(--text-sub);margin-bottom:5px;">Top Interests</div>
    <div class="interest-tags">
      ${(rpt.topInterests||[]).map(i=>`<span class="interest-tag">${escHtml(i)}</span>`).join('')}
    </div>`;
  grid.appendChild(snap);

  // Strengths
  const str = document.createElement('div');
  str.className = 'report-card';
  str.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#d1fae5">ğŸ’ª</div>Key Strengths</div>
    <ul class="strength-list">
      ${(rpt.keyStrengths||[]).map(s=>`<li class="strength-item">${escHtml(s)}</li>`).join('')}
    </ul>`;
  grid.appendChild(str);

  // Career Paths
  const paths = document.createElement('div');
  paths.className = 'report-card full';
  paths.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#ffedd5">ğŸ¯</div>Recommended Career Paths</div>
    ${(rpt.careerPaths||[]).map((cp,i) => `
      <div class="career-path-card">
        <div class="career-path-header" style="background:${['#f0f4ff','#f0fdf4','#fff7ed'][i]||'#f9fafb'}">
          <div class="career-path-title">${i+1}. ${escHtml(cp.name||'')}</div>
          <span class="career-cluster">${escHtml(cp.cluster||'')}</span>
        </div>
        <div class="career-path-body">
          <ul class="why-list">
            ${(cp.fitReasons||cp.reasons||[]).map(r=>`<li class="why-item"><span class="why-bullet">âœ¦</span>${escHtml(r)}</li>`).join('')}
          </ul>
          <div class="skill-chips">
            ${(cp.skills||[]).map(s=>`<span class="skill-chip">${escHtml(s)}</span>`).join('')}
          </div>
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-sub);margin-top:12px;margin-bottom:2px;">Application Hints</div>
          <ul class="hint-list">
            ${(cp.applicationHints||cp.hints||[]).map((h,hi)=>`<li class="hint-item"><span class="hint-num">${hi+1}</span>${escHtml(h)}</li>`).join('')}
          </ul>
        </div>
      </div>`).join('')}`;
  grid.appendChild(paths);

  // Next Steps
  const next = document.createElement('div');
  next.className = 'report-card full';
  next.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#fce7f3">ğŸš€</div>Suggested Next Steps</div>
    <ul class="why-list">
      ${(rpt.nextSteps||[]).map(s=>`<li class="why-item"><span class="why-bullet" style="color:var(--accent)">â†’</span>${escHtml(s)}</li>`).join('')}
    </ul>`;
  grid.appendChild(next);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF DOWNLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('btn-dl-pdf').addEventListener('click', async () => {
  const btn = $('btn-dl-pdf');
  btn.disabled = true;
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin-slow .8s linear infinite"><circle cx="12" cy="12" r="10"/></svg> Generating PDFâ€¦`;

  try {
    const blob = await apiReportPDF(state.messages);
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = `career_report_${state.student.name.replace(/\s+/g,'_')}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('PDF downloaded!', 'success');
  } catch(e) {
    showToast(`PDF failed: ${e.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Download PDF`;
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEXT INPUT EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); }
});
$('chat-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100) + 'px';
});
$('send-btn').addEventListener('click', sendUserMessage);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('read-more-toggle').addEventListener('click', () => {
  const list = document.querySelector('.instructions-list');
  const shown = list.style.display !== 'none';
  list.style.display = shown ? 'none' : '';
  $('read-more-toggle').textContent = shown ? 'â–¾ Read more' : 'â–´ Collapse';
});

$('btn-listen-instr').addEventListener('click', () => {
  const text = 'Welcome to Career Discovery AI. Speak using the microphone or type your responses. Ivy will guide you through questions about your interests, strengths, and preferences to recommend the best career paths for you.';
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.rate = .95;
    window.speechSynthesis.speak(utt);
  }
});


</script>
</body>
</html>
