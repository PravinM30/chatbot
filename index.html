<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Career Discovery AI</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:         #f4f5f9;
    --surface:    #ffffff;
    --border:     #e8eaf0;
    --border2:    #ececf1;
    --text-main:  #1a1d2e;
    --text-sub:   #6b7280;
    --text-light: #9ca3af;
    --accent:     #5b8cff;
    --accent2:    #a78bfa;
    --green:      #34d399;
    --pink:       #f472b6;
    --orange:     #fb923c;
    --red:        #f87171;
    --ai-bubble:  #f0f1f7;
    --user-bubble:#e9efff;
    --shadow-sm:  0 1px 3px rgba(0,0,0,.06);
    --shadow-md:  0 4px 16px rgba(0,0,0,.08);
    --shadow-lg:  0 8px 32px rgba(0,0,0,.10);
    --radius-sm:  8px;
    --radius-md:  14px;
    --radius-lg:  20px;
    --font:       'DM Sans', sans-serif;
  }

  html, body { height: 100%; font-family: var(--font); background: var(--bg); color: var(--text-main); font-size: 14px; line-height: 1.55; -webkit-font-smoothing: antialiased; }

  .app-shell { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* TOPBAR */
  .topbar { display: flex; align-items: center; gap: 10px; padding: 0 20px; height: 52px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 10; }
  .topbar-logo { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 15px; color: var(--text-main); text-decoration: none; }
  .topbar-logo .logo-mark { width: 22px; height: 22px; border-radius: 6px; background: linear-gradient(135deg, #5b8cff, #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 11px; color: #fff; font-weight: 700; }
  .topbar-logo .logo-text span { color: #5b8cff; }
  .topbar-divider { color: var(--border); margin: 0 2px; font-size: 18px; }
  .topbar-title { font-weight: 600; font-size: 14px; color: var(--text-main); white-space: nowrap; }
  .breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-sub); min-width: 0; flex: 1; }
  .breadcrumb svg { width: 14px; height: 14px; opacity: .5; flex-shrink: 0; }
  .breadcrumb .crumb { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .word-badge { display: inline-flex; align-items: center; gap: 4px; background: #fff0f6; color: #db2777; border: 1px solid #fce7f3; border-radius: 20px; font-size: 11px; font-weight: 600; padding: 3px 10px; flex-shrink: 0; }
  .word-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #f472b6; }
  .topbar-actions { display: flex; align-items: center; gap: 8px; margin-left: auto; }
  .avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #5b8cff, #a78bfa); font-size: 12px; font-weight: 600; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }

  /* STATUS BAR */
  .status-bar { display: flex; align-items: center; gap: 8px; padding: 5px 20px; background: #f9fafb; border-bottom: 1px solid var(--border); font-size: 11.5px; color: var(--text-sub); flex-shrink: 0; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #d1d5db; flex-shrink: 0; }
  .status-dot.ok { background: var(--green); animation: pulse-dot 2s ease-in-out infinite; }
  .status-dot.error { background: #f87171; }
  .status-dot.loading { background: var(--orange); animation: pulse-dot 1s ease-in-out infinite; }
  .status-sep { color: var(--border); }

  /* MAIN CONTENT */
  .main-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 16px 20px; gap: 12px; }

  /* INSTRUCTIONS BANNER */
  .instructions-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 18px; flex-shrink: 0; box-shadow: var(--shadow-sm); }
  .instructions-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .instructions-title { font-weight: 600; font-size: 13.5px; color: var(--text-main); }
  .listen-btn { display: flex; align-items: center; gap: 6px; background: #f9fafb; border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-size: 12px; font-weight: 500; color: var(--text-sub); cursor: pointer; transition: all .18s; }
  .listen-btn:hover { border-color: var(--accent); color: var(--accent); background: #f0f4ff; }
  .listen-btn svg { width: 13px; height: 13px; }
  .instructions-list { list-style: none; display: flex; flex-direction: column; gap: 4px; }
  .instructions-list li { font-size: 12.5px; color: var(--text-sub); display: flex; gap: 8px; }
  .instructions-list li span.num { color: var(--text-light); font-size: 11px; min-width: 14px; }
  .read-more { display: inline-flex; align-items: center; gap: 4px; font-size: 11.5px; color: var(--accent); cursor: pointer; margin-top: 6px; font-weight: 500; }

  /* PANEL WRAPPER */
  .panel-wrapper { flex: 1; overflow: hidden; display: flex; gap: 12px; min-height: 0; }

  /* CONVERSATION CARD */
  .conv-card { flex: 1; min-width: 0; background: var(--surface); border-radius: var(--radius-lg); border: 1.5px solid transparent; background-clip: padding-box; box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden; position: relative; }
  .conv-card::before { content: ''; position: absolute; inset: -1.5px; border-radius: calc(var(--radius-lg) + 1.5px); background: linear-gradient(135deg, #5b8cff33 0%, #a78bfa33 50%, #34d39933 100%); z-index: 0; pointer-events: none; }
  .conv-inner { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100%; background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; }
  .conv-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border2); flex-shrink: 0; }
  .conv-title { font-weight: 600; font-size: 13.5px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
  .conv-phase-badge { background: linear-gradient(135deg, #ede9fe, #dbeafe); color: #5b21b6; font-size: 10.5px; font-weight: 600; padding: 2px 9px; border-radius: 20px; letter-spacing: .2px; }
  .conv-meta { display: flex; align-items: center; gap: 6px; font-size: 11.5px; color: var(--text-sub); }

  /* MESSAGES */
  .messages-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
  .messages-area::-webkit-scrollbar { width: 4px; }
  .messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .msg-row { display: flex; gap: 10px; align-items: flex-start; }
  .msg-row.user { flex-direction: row-reverse; }
  .ai-avatar-ring { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; }
  .ai-avatar-ring::before { content: ''; position: absolute; inset: -2px; border-radius: 50%; background: conic-gradient(#5b8cff 0deg,#a78bfa 90deg,#f472b6 180deg,#fb923c 270deg,#34d399 320deg,#5b8cff 360deg); animation: spin-slow 4s linear infinite; z-index: 0; pointer-events: none; }
  .ai-avatar-ring-inner { position: relative; z-index: 1; width: 26px; height: 26px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; }
  .ai-avatar-ring-inner svg { width: 12px; height: 12px; color: var(--accent); }
  @keyframes spin-slow { to { transform: rotate(360deg); } }
  .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .bubble { max-width: 78%; padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.6; }
  .bubble.ai { background: var(--ai-bubble); border-top-left-radius: 4px; color: var(--text-main); animation: pop-in .28s cubic-bezier(.34,1.56,.64,1) both; }
  .bubble.user { background: var(--user-bubble); border-top-right-radius: 4px; color: var(--text-main); animation: pop-in .28s cubic-bezier(.34,1.56,.64,1) both; }
  @keyframes pop-in { from { opacity: 0; transform: scale(.9) translateY(6px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  .question-label { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
  .question-label .q-num { font-size: 11px; font-weight: 700; color: var(--accent); background: #e9efff; padding: 1px 7px; border-radius: 10px; }
  .question-label .q-title { font-size: 11px; font-weight: 600; color: var(--text-sub); }

  /* TYPING INDICATOR */
  .typing-bubble { display: flex; align-items: center; gap: 4px; padding: 12px 16px; background: var(--ai-bubble); border-radius: 16px; border-top-left-radius: 4px; width: fit-content; }
  .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-light); animation: bounce 1.2s ease-in-out infinite; }
  .typing-dot:nth-child(2) { animation-delay: .2s; }
  .typing-dot:nth-child(3) { animation-delay: .4s; }
  @keyframes bounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }

  /* INPUT AREA */
  .input-area { padding: 12px 14px; border-top: 1px solid var(--border2); display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; background: var(--surface); }

  /* AUDIO LEVEL METER */
  .audio-meter-wrap { display: none; align-items: center; gap: 8px; padding: 6px 10px; background: #f9fafb; border-radius: 10px; border: 1px solid var(--border); }
  .audio-meter-wrap.visible { display: flex; }
  .audio-meter-label { font-size: 11px; font-weight: 600; color: var(--text-sub); white-space: nowrap; }
  .audio-meter-bar-track { flex: 1; height: 6px; background: var(--border); border-radius: 6px; overflow: hidden; }
  .audio-meter-bar-fill { height: 100%; width: 0%; border-radius: 6px; background: linear-gradient(90deg, #34d399, #5b8cff, #f472b6); transition: width 0.08s ease-out; }
  .audio-meter-status { font-size: 10.5px; font-weight: 600; min-width: 80px; text-align: right; }
  .audio-meter-status.recording { color: var(--pink); }
  .audio-meter-status.silence { color: var(--text-light); }
  .audio-meter-status.speaking { color: var(--green); }

  .input-row { display: flex; align-items: center; gap: 10px; }
  .text-input { flex: 1; border: 1.5px solid var(--border); border-radius: 24px; padding: 9px 16px; font-family: var(--font); font-size: 13px; color: var(--text-main); background: var(--bg); outline: none; transition: border-color .18s; resize: none; height: 40px; line-height: 1.4; }
  .text-input:focus { border-color: var(--accent); background: #fff; }
  .text-input::placeholder { color: var(--text-light); }
  .text-input:disabled { opacity: .6; cursor: not-allowed; }

  /* SEND BUTTON */
  .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .18s; flex-shrink: 0; }
  .send-btn:hover { background: #3f72f0; transform: scale(1.06); }
  .send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  .send-btn svg { width: 15px; height: 15px; color: #fff; }

  /* MIC BUTTON */
  .mic-btn-wrap { position: relative; width: 40px; height: 40px; cursor: pointer; flex-shrink: 0; }
  .mic-btn-ring { position: absolute; inset: -4px; border-radius: 50%; background: conic-gradient(#5b8cff 0deg,#a78bfa 60deg,#f472b6 120deg,#fb923c 180deg,#facc15 220deg,#34d399 280deg,#22d3ee 320deg,#5b8cff 360deg); filter: blur(3px); animation: spin-slow 3s linear infinite; opacity: .85; }
  .mic-btn-core { position: relative; z-index: 1; width: 100%; height: 100%; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform .18s, background .18s; }
  .mic-btn-core:hover { transform: scale(1.06); }
  .mic-btn-core svg { width: 17px; height: 17px; color: var(--accent); }
  .mic-btn-wrap.recording .mic-btn-ring { animation: spin-slow 0.8s linear infinite; opacity: 1; filter: blur(5px); }
  .mic-btn-wrap.recording .mic-btn-core { background: #fff0f6; }
  .mic-btn-wrap.recording .mic-btn-core svg { color: var(--pink); }
  .mic-btn-wrap.processing .mic-btn-core { background: #f0f4ff; }
  .mic-btn-wrap.processing .mic-btn-ring { opacity: .5; }

  /* VOICE VISUALIZER */
  .voice-vis { display: flex; align-items: center; gap: 2px; height: 18px; }
  .voice-bar { width: 3px; background: linear-gradient(to top, #5b8cff, #a78bfa); border-radius: 2px; animation: bar-dance 1s ease-in-out infinite; }
  .voice-bar:nth-child(1) { height: 6px;  animation-delay: .0s; }
  .voice-bar:nth-child(2) { height: 12px; animation-delay: .1s; }
  .voice-bar:nth-child(3) { height: 18px; animation-delay: .2s; }
  .voice-bar:nth-child(4) { height: 12px; animation-delay: .3s; }
  .voice-bar:nth-child(5) { height: 6px;  animation-delay: .4s; }
  @keyframes bar-dance { 0%,100% { transform: scaleY(.4); } 50% { transform: scaleY(1); } }

  /* NOTES PANEL */
  .notes-panel { width: 260px; flex-shrink: 0; background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden; }
  .notes-header { padding: 12px 14px; border-bottom: 1px solid var(--border2); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .notes-title { font-weight: 600; font-size: 12.5px; color: var(--text-main); display: flex; align-items: center; gap: 7px; }
  .notes-title .icon-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse-dot 2s ease-in-out infinite; }
  @keyframes pulse-dot { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: .5; transform: scale(1.3); } }
  .notes-scroll { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
  .notes-scroll::-webkit-scrollbar { width: 3px; }
  .notes-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .note-card { background: #f9fafc; border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 10px 12px; animation: slide-in .3s ease both; }
  @keyframes slide-in { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
  .note-phase { display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: var(--accent); margin-bottom: 5px; }
  .note-phase-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }
  .note-label { font-size: 11.5px; font-weight: 600; color: var(--text-main); margin-bottom: 3px; }
  .note-value { font-size: 11.5px; color: var(--text-sub); line-height: 1.5; }
  .note-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
  .note-tag { background: #ede9fe; color: #5b21b6; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
  .note-tag.green { background: #d1fae5; color: #065f46; }
  .note-tag.blue { background: #dbeafe; color: #1e40af; }

  /* ACTION BAR */
  .action-bar { display: flex; align-items: center; justify-content: flex-end; padding: 10px 20px; flex-shrink: 0; background: transparent; }
  .cta-btn { display: flex; align-items: center; gap: 8px; background: var(--accent); color: #fff; border: none; border-radius: 24px; padding: 10px 22px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; box-shadow: 0 3px 12px rgba(91,140,255,.35); }
  .cta-btn:hover { background: #3f72f0; transform: translateY(-1px); }
  .cta-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
  .cta-btn svg { width: 15px; height: 15px; }

  /* SCREENS */
  .screen { display: none; }
  .screen.active { display: flex; flex-direction: column; height: 100%; }

  /* FORM SCREEN */
  .form-screen-inner { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .form-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 32px 36px; width: 100%; max-width: 480px; box-shadow: var(--shadow-lg); animation: pop-in .35s cubic-bezier(.34,1.56,.64,1) both; }
  .form-card-header { text-align: center; margin-bottom: 24px; }
  .form-logo-ring { width: 52px; height: 52px; border-radius: 50%; background: conic-gradient(#5b8cff, #a78bfa, #f472b6, #34d399, #5b8cff); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; animation: spin-slow 5s linear infinite; }
  .form-logo-inner { width: 44px; height: 44px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; }
  .form-logo-inner svg { width: 22px; height: 22px; color: var(--accent); }
  .form-card h2 { font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
  .form-card p { font-size: 13px; color: var(--text-sub); }
  .field-group { margin-bottom: 14px; }
  .field-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 5px; text-transform: uppercase; letter-spacing: .4px; }
  .field-input, .field-select, .field-textarea { width: 100%; padding: 9px 13px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-family: var(--font); font-size: 13px; color: var(--text-main); background: var(--bg); outline: none; transition: border-color .18s, box-shadow .18s; }
  .field-input:focus, .field-select:focus, .field-textarea:focus { border-color: var(--accent); background: #fff; box-shadow: 0 0 0 3px rgba(91,140,255,.12); }
  .field-textarea { resize: none; height: 72px; line-height: 1.5; }
  .field-row { display: flex; gap: 12px; }
  .field-row .field-group { flex: 1; }
  .submit-btn { width: 100%; padding: 11px; background: linear-gradient(135deg, #5b8cff, #a78bfa); color: #fff; border: none; border-radius: 24px; font-family: var(--font); font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 6px; transition: all .2s; box-shadow: 0 3px 14px rgba(91,140,255,.35); display: flex; align-items: center; justify-content: center; gap: 8px; }
  .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(91,140,255,.4); }
  .submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
  .submit-btn svg { width: 16px; height: 16px; }

  /* REPORT SCREEN */
  .report-scroll { flex: 1; overflow-y: auto; padding: 20px; }
  .report-scroll::-webkit-scrollbar { width: 5px; }
  .report-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
  .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; max-width: 900px; margin: 0 auto; }
  .report-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 18px 20px; box-shadow: var(--shadow-sm); animation: pop-in .4s cubic-bezier(.34,1.56,.64,1) both; }
  .report-card.full { grid-column: 1/-1; }
  .report-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--text-sub); margin-bottom: 10px; display: flex; align-items: center; gap: 7px; }
  .report-card-title .icon-sq { width: 20px; height: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
  .snapshot-name { font-size: 22px; font-weight: 700; color: var(--text-main); margin-bottom: 3px; }
  .snapshot-meta { font-size: 12.5px; color: var(--text-sub); margin-bottom: 12px; }
  .interest-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .interest-tag { background: linear-gradient(135deg, #ede9fe, #dbeafe); color: #3730a3; font-size: 11.5px; font-weight: 600; padding: 4px 12px; border-radius: 20px; }
  .strength-list { list-style: none; display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
  .strength-item { display: flex; align-items: center; gap: 8px; font-size: 12.5px; color: var(--text-main); }
  .strength-item::before { content: '‚ñ∏'; color: var(--accent); font-size: 11px; }
  .career-path-card { border-radius: var(--radius-md); border: 1.5px solid var(--border); overflow: hidden; margin-top: 8px; background: var(--surface); }
  .career-path-header { padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; }
  .career-path-title { font-size: 14px; font-weight: 700; color: var(--text-main); }
  .career-cluster { font-size: 10.5px; font-weight: 600; padding: 3px 10px; border-radius: 20px; background: #e9efff; color: var(--accent); }
  .career-path-body { padding: 0 15px 14px; }
  .why-list { list-style: none; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
  .why-item { font-size: 12px; color: var(--text-sub); display: flex; gap: 7px; line-height: 1.5; }
  .why-bullet { color: var(--green); font-size: 12px; flex-shrink: 0; }
  .skill-chips { display: flex; flex-wrap: wrap; gap: 5px; }
  .skill-chip { background: #f4f5f9; border: 1px solid var(--border); border-radius: 6px; font-size: 10.5px; font-weight: 500; padding: 3px 9px; color: var(--text-sub); }
  .hint-list { list-style: none; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
  .hint-item { font-size: 12px; color: var(--text-sub); display: flex; gap: 6px; }
  .hint-num { background: #ffedd5; color: #9a3412; font-size: 9.5px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .report-dl-btn { display: flex; align-items: center; gap: 8px; background: var(--surface); border: 1.5px solid var(--accent); color: var(--accent); border-radius: 24px; padding: 9px 20px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; }
  .report-dl-btn:hover { background: var(--accent); color: #fff; transform: translateY(-1px); }
  .report-dl-btn:disabled { opacity: .5; cursor: not-allowed; }
  .report-dl-btn svg { width: 15px; height: 15px; }

  /* PHASE DOTS */
  .phase-dots { display: flex; align-items: center; gap: 4px; }
  .phase-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: background .3s, transform .3s; }
  .phase-dot.done   { background: var(--green); }
  .phase-dot.active { background: var(--accent); transform: scale(1.3); }
  .timer-badge { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-sub); font-weight: 500; }
  .timer-badge svg { width: 12px; height: 12px; }

  /* TOAST */
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1f2937; color: #fff; padding: 10px 18px; border-radius: 10px; font-size: 12.5px; font-weight: 500; z-index: 9999; display: none; animation: pop-in .25s ease both; max-width: 400px; text-align: center; }
  .toast.error   { background: #7f1d1d; border: 1px solid #ef4444; }
  .toast.success { background: #064e3b; border: 1px solid #34d399; }
  .toast.show    { display: block; }

  /* LOADING */
  .report-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; padding: 60px 20px; color: var(--text-sub); font-size: 13px; grid-column: 1/-1; }
  .report-loading .spin-ring { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--border); border-top-color: var(--accent); animation: spin-slow .8s linear infinite; }

  /* D-FLEX helpers */
  .d-flex { display: flex; }
  .gap-8  { gap: 8px; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- SCREEN 1: FORM -->
<div class="app-shell screen active" id="screen-form">
  <div class="topbar">
    <a class="topbar-logo" href="#">
      <div class="logo-mark">hi</div>
      <span class="logo-text">hello<span>ivy</span></span>
    </a>
    <span class="topbar-divider">‚Ä∫</span>
    <span class="topbar-title">Career Discovery AI</span>
    <div class="topbar-actions">
      <div class="avatar">A</div>
    </div>
  </div>

  <div class="form-screen-inner">
    <div class="form-card">
      <div class="form-card-header">
        <div class="form-logo-ring">
          <div class="form-logo-inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 100 6 3 3 0 000-6zM6 8a6 6 0 0112 0M3 18a9 9 0 0118 0"/></svg>
          </div>
        </div>
        <h2>Career Discovery</h2>
        <p>Tell us about yourself to personalise your AI conversation</p>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">Full Name</label>
          <input class="field-input" type="text" id="inp-name" placeholder="e.g. Alex Chen" autocomplete="off">
        </div>
        <div class="field-group">
          <label class="field-label">Grade</label>
          <select class="field-select" id="inp-grade">
            <option value="">Select‚Ä¶</option>
            <option>Grade 9</option><option>Grade 10</option>
            <option>Grade 11</option><option>Grade 12</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">Board / Curriculum</label>
        <select class="field-select" id="inp-curriculum">
          <option value="">Select‚Ä¶</option>
          <option>CBSE</option><option>ICSE</option>
          <option>IB ‚Äì International Baccalaureate</option>
          <option>IGCSE</option><option>State Board</option><option>A-Levels</option>
        </select>
      </div>

      <div class="field-group">
        <label class="field-label">Favourite Subjects</label>
        <input class="field-input" type="text" id="inp-subjects" placeholder="e.g. Maths, Computer Science, Biology">
      </div>

      <div class="field-group">
        <label class="field-label">Interests &amp; Hobbies</label>
        <textarea class="field-textarea" id="inp-interests" placeholder="What excites you outside school? Coding, sport, art, music‚Ä¶"></textarea>
      </div>

      <button class="submit-btn" id="btn-start">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg>
        Start Voice Conversation
      </button>
    </div>
  </div>
</div>


<!-- SCREEN 2: CHAT -->
<div class="app-shell screen" id="screen-chat">
  <div class="topbar">
    <a class="topbar-logo" href="#">
      <div class="logo-mark">hi</div>
      <span class="logo-text">hello<span>ivy</span></span>
    </a>
    <span class="topbar-divider">‚Ä∫</span>
    <span class="topbar-title">Career Discovery Session</span>
    <div class="breadcrumb">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      <span class="crumb" id="bc-name">‚Äì</span>
    </div>
    <div class="word-badge">
      <span class="dot"></span>
      <span id="word-count">0</span> words
    </div>
    <div class="topbar-actions">
      <div class="avatar" id="chat-avatar">A</div>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="chat-status-dot"></div>
    <span id="chat-status-text">Connecting‚Ä¶</span>
    <span class="status-sep">¬∑</span>
    <span id="chat-model-info">STT: distil-whisper ¬∑ LLM: Llama-3.2-3B ¬∑ TTS: Kokoro</span>
  </div>

  <div class="main-content">
    <div class="instructions-card">
      <div class="instructions-header">
        <span class="instructions-title">Instructions</span>
        <button class="listen-btn" id="btn-listen-instr">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/></svg>
          Listen
        </button>
      </div>
      <ul class="instructions-list">
        <li><span class="num">1.</span> This is a short, focused voice session with Ivy AI.</li>
        <li><span class="num">2.</span> Click the mic button, speak clearly, then click again to stop ‚Äî Ivy will respond via voice and text.</li>
        <li><span class="num">3.</span> Watch the audio level bar to confirm the mic is picking up your voice before releasing.</li>
      </ul>
      <div class="read-more" id="read-more-toggle">Read more ‚ñæ</div>
    </div>

    <div class="panel-wrapper">
      <!-- CONVERSATION CARD -->
      <div class="conv-card">
        <div class="conv-inner">
          <div class="conv-header">
            <div class="conv-title">
              <span id="conv-title-text">Information Capture</span>
              <span class="conv-phase-badge" id="conv-phase-badge">Starting‚Ä¶</span>
            </div>
            <div class="d-flex gap-8" style="align-items:center">
              <div class="voice-vis hidden" id="voice-vis">
                <div class="voice-bar"></div><div class="voice-bar"></div>
                <div class="voice-bar"></div><div class="voice-bar"></div>
                <div class="voice-bar"></div>
              </div>
              <div class="timer-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span id="chat-timer">00:00</span>
              </div>
              <div class="phase-dots" id="phase-dots"></div>
            </div>
          </div>

          <div class="messages-area" id="messages-area"></div>

          <div class="input-area">
            <!-- AUDIO LEVEL METER ‚Äî shown while recording -->
            <div class="audio-meter-wrap" id="audio-meter-wrap">
              <span class="audio-meter-label">üéô Mic Level</span>
              <div class="audio-meter-bar-track">
                <div class="audio-meter-bar-fill" id="audio-meter-fill"></div>
              </div>
              <span class="audio-meter-status" id="audio-meter-status">Waiting‚Ä¶</span>
            </div>

            <div class="input-row">
              <textarea class="text-input" id="chat-input" placeholder="Type your response or use the mic‚Ä¶" rows="1"></textarea>
              <button class="send-btn" id="send-btn" title="Send">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
              <div class="mic-btn-wrap" id="mic-btn" title="Click to start recording, click again to stop">
                <div class="mic-btn-ring"></div>
                <div class="mic-btn-core" id="mic-btn-core">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NOTES PANEL -->
      <div class="notes-panel">
        <div class="notes-header">
          <div class="notes-title">
            <span class="icon-dot"></span>
            AI Notes
          </div>
          <div style="font-size:11px;color:var(--text-light);font-weight:500;" id="notes-count">0 insights</div>
        </div>
        <div class="notes-scroll" id="notes-scroll">
          <div style="text-align:center;padding:30px 10px;color:var(--text-light);font-size:12px;">Notes appear as the conversation progresses‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

  <div class="action-bar">
    <button class="cta-btn" id="btn-generate-report" disabled>
      Generate Full Report
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
  </div>
</div>


<!-- SCREEN 3: REPORT -->
<div class="app-shell screen" id="screen-report">
  <div class="topbar">
    <a class="topbar-logo" href="#">
      <div class="logo-mark">hi</div>
      <span class="logo-text">hello<span>ivy</span></span>
    </a>
    <span class="topbar-divider">‚Ä∫</span>
    <span class="topbar-title">Career Discovery Report</span>
    <div class="topbar-actions">
      <button class="report-dl-btn" id="btn-dl-pdf">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Download PDF
      </button>
      <div class="avatar" id="report-avatar">A</div>
    </div>
  </div>
  <div class="report-scroll">
    <div class="report-grid" id="report-grid"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let API_BASE = 'https://multilinear-overtenaciously-timmy.ngrok-free.dev';
const NGROK_H = { 'ngrok-skip-browser-warning': 'any' };

const PHASES = [
  { id:'welcome',     label:'Welcome',     title:'Information Capture',  badge:'Starting‚Ä¶' },
  { id:'interests',   label:'Interests',   title:'Exploring Interests',  badge:'1/6 answered' },
  { id:'strengths',   label:'Strengths',   title:'Discovering Strengths',badge:'2/6 answered' },
  { id:'preferences', label:'Preferences', title:'Work Preferences',     badge:'3/6 answered' },
  { id:'scenarios',   label:'Scenarios',   title:'Career Scenarios',     badge:'4/6 answered' },
  { id:'refinement',  label:'Refinement',  title:'Narrowing Down',       badge:'5/6 answered' },
  { id:'summary',     label:'Summary',     title:'Wrapping Up',          badge:'6/6 answered' },
];

const state = {
  student: {},
  phaseIdx: 0,
  messages: [],
  notes: [],
  timerSec: 0,
  timerHandle: null,
  wordCount: 0,
  // recording state
  isRecording: false,
  mediaRecorder: null,
  audioChunks: [],
  recordingStart: 0,
  recordingTimer: null,
  // audio analysis
  audioCtx: null,
  analyserNode: null,
  micStream: null,
  levelRafId: null,
  peakLevel: 0,
  // TTS
  currentAudio: null,
  isSpeaking: false,
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILITIES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $ = id => document.getElementById(id);

function escHtml(t) {
  return String(t||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function showToast(msg, type='error', duration=4000) {
  const t = $('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(t._hide);
  t._hide = setTimeout(() => { t.className = 'toast'; }, duration);
}

const screens = { form: $('screen-form'), chat: $('screen-chat'), report: $('screen-report') };
function showScreen(name) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[name].classList.add('active');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   API
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function base() { return API_BASE.replace(/\/+$/, ''); }

async function apiHealth() {
  const r = await fetch(`${base()}/api/health`, { headers: NGROK_H, signal: AbortSignal.timeout(8000) });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function apiLLM(messages, phase) {
  const r = await fetch(`${base()}/api/llm`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json','ngrok-skip-browser-warning': 'any'  },
    body: JSON.stringify({
      student: {
        name: state.student.name, grade: state.student.grade,
        curriculum: state.student.curriculum,
        subjects: state.student.subjects||'', interests: state.student.interests||'',
      },
      messages, phase,
    }),
    signal: AbortSignal.timeout(120000),
  });
  if (!r.ok) throw new Error(`LLM ${r.status}: ${await r.text()}`);
  return r.json();
}

/* ‚îÄ‚îÄ STT: single, clean definition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Picks the best MIME, creates FormData with correct filename,
   sends to backend, retries once on 500. */
async function apiSTT(blob, mimeType) {
  const ext = mimeToExt(mimeType);
  const fd  = new FormData();
  fd.append('audio', blob, `recording.${ext}`);

  const doFetch = () => fetch(`${base()}/api/stt`, {
    method: 'POST',
    headers: NGROK_H,   // ‚Üê NO Content-Type; FormData sets boundary automatically
    body: fd,
    signal: AbortSignal.timeout(45000),
  });

  let r = await doFetch();
  // Retry once on server error (model may have been sleeping)
  if (r.status >= 500) {
    await new Promise(res => setTimeout(res, 1500));
    r = await doFetch();
  }
  if (!r.ok) throw new Error(`STT ${r.status}: ${await r.text()}`);
  return r.json();
}

async function apiTTS(text) {
  const r = await fetch(`${base()}/api/tts`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...NGROK_H },
    body: JSON.stringify({ text }),
    signal: AbortSignal.timeout(60000),
  });
  if (!r.ok) throw new Error(`TTS ${r.status}`);
  return r.blob();
}

async function apiReport(history) {
  const r = await fetch(`${base()}/api/report`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...NGROK_H },
    body: JSON.stringify({
      student: {
        name: state.student.name, grade: state.student.grade,
        curriculum: state.student.curriculum,
        subjects: state.student.subjects||'', interests: state.student.interests||'',
      },
      history,
    }),
    signal: AbortSignal.timeout(180000),
  });
  if (!r.ok) throw new Error(`Report ${r.status}`);
  return r.json();
}

async function apiReportPDF(history) {
  const r = await fetch(`${base()}/api/report/pdf`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...NGROK_H },
    body: JSON.stringify({
      student: {
        name: state.student.name, grade: state.student.grade,
        curriculum: state.student.curriculum,
        subjects: state.student.subjects||'', interests: state.student.interests||'',
      },
      history,
    }),
    signal: AbortSignal.timeout(180000),
  });
  if (!r.ok) throw new Error(`PDF ${r.status}`);
  return r.blob();
}

function mimeToExt(mime='') {
  if (mime.includes('ogg'))  return 'ogg';
  if (mime.includes('mp4'))  return 'mp4';
  if (mime.includes('webm')) return 'webm';
  if (mime.includes('wav'))  return 'wav';
  return 'webm';
}

/* Pick the best supported MIME type for recording */
function bestMimeType() {
  const candidates = [
    'audio/webm;codecs=opus',
    'audio/webm',
    'audio/ogg;codecs=opus',
    'audio/ogg',
    'audio/mp4',
  ];
  return candidates.find(m => MediaRecorder.isTypeSupported(m)) || '';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FORM SUBMIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('btn-start').addEventListener('click', async () => {
  const name  = $('inp-name').value.trim();
  const grade = $('inp-grade').value;
  const curr  = $('inp-curriculum').value;
  if (!name || !grade || !curr) {
    [$('inp-name'), $('inp-grade'), $('inp-curriculum')].forEach(el => {
      if (!el.value.trim()) { el.style.borderColor='#f472b6'; setTimeout(()=>{el.style.borderColor='';},2000); }
    });
    showToast('Please fill in Name, Grade, and Curriculum.', 'error');
    return;
  }
  const btn = $('btn-start');
  btn.disabled = true;
  btn.textContent = 'Connecting‚Ä¶';
  try {
    await apiHealth();
  } catch(e) {
    showToast(`Cannot reach backend: ${e.message}`, 'error');
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg> Start Voice Conversation`;
    return;
  }
  state.student = {
    name, grade, curriculum: curr,
    subjects:  $('inp-subjects').value.trim(),
    interests: $('inp-interests').value.trim(),
    initials:  name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(),
  };
  $('bc-name').textContent         = name;
  $('chat-avatar').textContent     = state.student.initials;
  $('report-avatar').textContent   = state.student.initials;
  showScreen('chat');
  initChat();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHAT INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initChat() {
  buildPhaseDots();
  startTimer();
  state.phaseIdx  = 0;
  state.messages  = [];
  state.notes     = [];
  state.wordCount = 0;
  $('messages-area').innerHTML = '';
  $('notes-scroll').innerHTML  = '<div style="text-align:center;padding:30px 10px;color:var(--text-light);font-size:12px;">Notes appear as the conversation progresses‚Ä¶</div>';
  $('word-count').textContent  = '0';
  $('chat-status-dot').className = 'status-dot ok';
  $('chat-status-text').textContent = `Connected ‚Äî ${API_BASE}`;
  askLLM('welcome');
}

/* TIMER */
function startTimer() {
  state.timerSec = 0;
  clearInterval(state.timerHandle);
  state.timerHandle = setInterval(() => {
    state.timerSec++;
    const m = String(Math.floor(state.timerSec/60)).padStart(2,'0');
    const s = String(state.timerSec%60).padStart(2,'0');
    $('chat-timer').textContent = `${m}:${s}`;
  }, 1000);
}

/* PHASE DOTS */
function buildPhaseDots() {
  const wrap = $('phase-dots');
  wrap.innerHTML = '';
  PHASES.forEach((_,i) => {
    const d = document.createElement('div');
    d.className = 'phase-dot';
    d.id = `dot-${i}`;
    wrap.appendChild(d);
  });
}

function updatePhaseDots() {
  PHASES.forEach((_,i) => {
    const d = $(`dot-${i}`);
    if (!d) return;
    d.classList.remove('done','active');
    if (i < state.phaseIdx) d.classList.add('done');
    else if (i === state.phaseIdx) d.classList.add('active');
  });
  const ph = PHASES[Math.min(state.phaseIdx, PHASES.length-1)];
  $('conv-title-text').textContent  = ph.title;
  $('conv-phase-badge').textContent = ph.badge;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LLM INTERACTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function askLLM(phaseId) {
  const typingEl = showTypingIndicator();
  setInputEnabled(false);
  try {
    const resp = await apiLLM(state.messages, phaseId);
    hideTypingIndicator(typingEl);
    const aiText = resp.reply || '';
    state.messages.push({ role: 'assistant', content: aiText });
    renderAIBubble(aiText, state.phaseIdx);
    updatePhaseDots();
    if (resp.insights && Object.keys(resp.insights).length > 0) {
      addInsightNote(resp.insights, PHASES[state.phaseIdx]?.label || 'Session');
    }
    speakText(aiText);
  } catch(e) {
    hideTypingIndicator(typingEl);
    showToast(`AI response failed: ${e.message}`, 'error');
    $('chat-status-dot').className = 'status-dot error';
    $('chat-status-text').textContent = 'LLM error ‚Äî try again';
  } finally {
    setInputEnabled(true);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TTS PLAYBACK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function speakText(text) {
  if (!text || text.length < 3) return;
  try {
    $('voice-vis').classList.remove('hidden');
    state.isSpeaking = true;
    const blob = await apiTTS(text.slice(0, 400));
    const url  = URL.createObjectURL(blob);
    if (state.currentAudio) {
      state.currentAudio.pause();
      URL.revokeObjectURL(state.currentAudio._url || '');
    }
    const audio = new Audio(url);
    audio._url = url;
    state.currentAudio = audio;
    audio.onended = () => {
      state.isSpeaking = false;
      $('voice-vis').classList.add('hidden');
      URL.revokeObjectURL(url);
    };
    audio.onerror = () => {
      state.isSpeaking = false;
      $('voice-vis').classList.add('hidden');
    };
    await audio.play();
  } catch(e) {
    state.isSpeaking = false;
    $('voice-vis').classList.add('hidden');
    console.warn('TTS non-fatal:', e.message);
  }
}

function stopTTS() {
  if (state.currentAudio) {
    state.currentAudio.pause();
    state.currentAudio = null;
  }
  state.isSpeaking = false;
  $('voice-vis').classList.add('hidden');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUDIO LEVEL METER (Web Audio API)
   Reads mic volume in real-time during recording
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startAudioMeter(stream) {
  try {
    state.audioCtx    = new (window.AudioContext || window.webkitAudioContext)();
    state.analyserNode = state.audioCtx.createAnalyser();
    state.analyserNode.fftSize = 256;
    state.analyserNode.smoothingTimeConstant = 0.4;

    const src = state.audioCtx.createMediaStreamSource(stream);
    src.connect(state.analyserNode);

    const dataArr = new Uint8Array(state.analyserNode.frequencyBinCount);
    const meterFill   = $('audio-meter-fill');
    const meterStatus = $('audio-meter-status');
    const meterWrap   = $('audio-meter-wrap');
    meterWrap.classList.add('visible');

    let silenceFrames = 0;
    const SILENCE_THRESHOLD = 8;   // RMS below this = silence
    const SILENCE_FRAMES    = 15;  // ~250ms of silence to mark as quiet

    function tick() {
      if (!state.isRecording) return;

      state.analyserNode.getByteFrequencyData(dataArr);

      // Compute RMS energy
      let sum = 0;
      for (let i = 0; i < dataArr.length; i++) sum += dataArr[i] * dataArr[i];
      const rms = Math.sqrt(sum / dataArr.length);
      const pct = Math.min(100, (rms / 128) * 100 * 2.5);

      meterFill.style.width = pct + '%';
      state.peakLevel = Math.max(state.peakLevel, rms);

      if (rms < SILENCE_THRESHOLD) {
        silenceFrames++;
        if (silenceFrames > SILENCE_FRAMES) {
          meterStatus.textContent = 'Silence';
          meterStatus.className   = 'audio-meter-status silence';
        }
      } else {
        silenceFrames = 0;
        meterStatus.textContent = rms > 40 ? 'üîä Loud' : '‚úî Voice detected';
        meterStatus.className   = 'audio-meter-status speaking';
      }

      state.levelRafId = requestAnimationFrame(tick);
    }
    tick();
  } catch(e) {
    console.warn('AudioContext not available:', e.message);
  }
}

function stopAudioMeter() {
  cancelAnimationFrame(state.levelRafId);
  try { state.audioCtx?.close(); } catch(_) {}
  state.audioCtx     = null;
  state.analyserNode = null;
  const meterWrap = $('audio-meter-wrap');
  meterWrap.classList.remove('visible');
  $('audio-meter-fill').style.width = '0%';
  $('audio-meter-status').textContent = 'Waiting‚Ä¶';
  $('audio-meter-status').className   = 'audio-meter-status';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RECORDING  (click-to-start / click-to-stop)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('mic-btn').addEventListener('click', () => {
  if (state.isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
});

async function startRecording() {
  // Stop TTS if playing
  stopTTS();

  // Request mic
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        channelCount:     1,
        sampleRate:       { ideal: 16000 },
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl:  true,
      }
    });
  } catch(e) {
    showToast('Microphone access denied. Please allow mic in browser settings.', 'error');
    return;
  }

  state.micStream     = stream;
  state.audioChunks   = [];
  state.recordingStart = Date.now();
  state.peakLevel     = 0;

  // Choose MIME type
  const mimeType = bestMimeType();
  console.log('[STT] Recording MIME:', mimeType || '(browser default)');

  // Build MediaRecorder ‚Äî collect one big blob (no timeslice) to avoid chunk ordering issues
  let mr;
  try {
    mr = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
  } catch(_) {
    mr = new MediaRecorder(stream);
  }
  state.mediaRecorder = mr;

  mr.ondataavailable = e => {
    if (e.data && e.data.size > 0) state.audioChunks.push(e.data);
  };

  mr.onstop = () => handleRecordingStop(mr.mimeType || mimeType || 'audio/webm');

  // Start WITHOUT timeslice ‚Äî data arrives in one chunk at .stop()
  // This prevents partial chunk ordering / corruption on some browsers.
  mr.start();

  state.isRecording = true;
  $('mic-btn').classList.add('recording');
  setInputEnabled(false);

  // Start the live audio level meter
  startAudioMeter(stream);

  // Update placeholder with live second counter
  let secs = 0;
  $('chat-input').placeholder = 'üéô Recording‚Ä¶ click mic to stop';
  state.recordingTimer = setInterval(() => {
    secs++;
    $('chat-input').placeholder = `üéô Recording ${secs}s‚Ä¶ click mic to stop`;
  }, 1000);
}

function stopRecording() {
  if (!state.isRecording) return;
  state.isRecording = false;
  clearInterval(state.recordingTimer);
  $('mic-btn').classList.remove('recording');
  $('mic-btn').classList.add('processing');
  $('chat-input').placeholder = '‚è≥ Processing audio‚Ä¶';

  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.stop();
  }
  // Stop all tracks
  if (state.micStream) {
    state.micStream.getTracks().forEach(t => t.stop());
    state.micStream = null;
  }
  // Stop meter
  stopAudioMeter();
}

async function handleRecordingStop(mimeType) {
  $('mic-btn').classList.remove('processing');

  const durationMs = Date.now() - state.recordingStart;

  // Guard: too short
  if (durationMs < 800) {
    showToast('Recording was too short. Hold the mic button while you speak.', 'error');
    resetInputAfterSTT();
    return;
  }

  // Guard: silent recording
  if (state.peakLevel < 5) {
    showToast("No audio detected. Make sure your microphone is not muted and speak clearly.", 'error');
    resetInputAfterSTT();
    return;
  }

  const blob = new Blob(state.audioChunks, { type: mimeType });
  console.log(`[STT] blob=${(blob.size/1024).toFixed(1)}KB  mime=${mimeType}  duration=${durationMs}ms  peak=${state.peakLevel.toFixed(1)}`);

  // Minimum size sanity check (too small = almost certainly silence)
  if (blob.size < 1500) {
    showToast('Recording seems empty. Try speaking closer to the microphone.', 'error');
    resetInputAfterSTT();
    return;
  }

  $('chat-input').placeholder = 'üîÑ Transcribing‚Ä¶';

  try {
    const result = await apiSTT(blob, mimeType);
    const text   = (result.text || '').trim();

    if (text && text.length > 1) {
      $('chat-input').value = text;
      $('chat-input').placeholder = 'Type your response or use the mic‚Ä¶';
      setInputEnabled(true);
      showToast(`‚úî Transcribed: "${text.slice(0,60)}${text.length>60?'‚Ä¶':''}"`, 'success', 2500);
      // Small delay so user can see/edit the transcription
      setTimeout(sendUserMessage, 700);
    } else {
      showToast("Couldn't transcribe speech. Try speaking louder or moving closer to the mic.", 'error');
      resetInputAfterSTT();
    }
  } catch(e) {
    showToast(`Transcription failed: ${e.message}`, 'error');
    resetInputAfterSTT();
  }
}

function resetInputAfterSTT() {
  $('chat-input').placeholder = 'Type your response or use the mic‚Ä¶';
  $('chat-input').disabled = false;
  $('send-btn').disabled   = false;
  $('mic-btn').classList.remove('recording', 'processing');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEND USER MESSAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sendUserMessage() {
  const input = $('chat-input');
  const text  = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';

  state.wordCount += text.split(/\s+/).filter(Boolean).length;
  $('word-count').textContent = state.wordCount;

  renderUserBubble(text);
  state.messages.push({ role: 'user', content: text });

  state.phaseIdx = Math.min(state.phaseIdx + 1, PHASES.length - 1);

  if (state.phaseIdx >= 3) $('btn-generate-report').disabled = false;

  const phaseId = PHASES[state.phaseIdx]?.id || 'summary';
  await askLLM(phaseId);

  if (state.phaseIdx >= PHASES.length - 1) {
    setTimeout(() => {
      $('btn-generate-report').disabled = false;
      showToast('Session complete! Click "Generate Full Report" for your personalised career report.', 'success', 6000);
    }, 2000);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER BUBBLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderAIBubble(text, phaseIdx) {
  const area = $('messages-area');
  const row  = document.createElement('div');
  row.className = 'msg-row';
  const qLabel = phaseIdx > 0 ? `
    <div class="question-label">
      <span class="q-num">Q${phaseIdx}</span>
      <span class="q-title">${PHASES[phaseIdx]?.label||''}</span>
    </div>` : '';
  row.innerHTML = `
    <div class="ai-avatar-ring">
      <div class="ai-avatar-ring-inner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2a3 3 0 100 6 3 3 0 000-6z"/>
          <path d="M12 12c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4z"/>
        </svg>
      </div>
    </div>
    <div class="bubble ai">${qLabel}${escHtml(text)}</div>`;
  area.appendChild(row);
  scrollChat();
}

function renderUserBubble(text) {
  const area = $('messages-area');
  const row  = document.createElement('div');
  row.className = 'msg-row user';
  row.innerHTML = `
    <div class="user-avatar">${state.student.initials}</div>
    <div class="bubble user">${escHtml(text)}</div>`;
  area.appendChild(row);
  scrollChat();
}

function showTypingIndicator() {
  const area = $('messages-area');
  const el   = document.createElement('div');
  el.className = 'msg-row';
  el.innerHTML = `
    <div class="ai-avatar-ring">
      <div class="ai-avatar-ring-inner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2a3 3 0 100 6 3 3 0 000-6z"/>
          <path d="M12 12c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4z"/>
        </svg>
      </div>
    </div>
    <div class="typing-bubble">
      <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
    </div>`;
  area.appendChild(el);
  scrollChat();
  return el;
}

function hideTypingIndicator(el) {
  if (el && el.parentNode) el.parentNode.removeChild(el);
}

function scrollChat() {
  const area = $('messages-area');
  area.scrollTop = area.scrollHeight;
}

function setInputEnabled(on) {
  $('chat-input').disabled = !on;
  $('send-btn').disabled   = !on;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INSIGHTS ‚Üí NOTES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addInsightNote(insights, phaseLabel) {
  const scroll = $('notes-scroll');
  if (state.notes.length === 0) scroll.innerHTML = '';
  const lines = [];
  if (insights.work_orientation)   lines.push(`Orientation: ${insights.work_orientation.join(', ')}`);
  if (insights.lifestyle)          lines.push(`Lifestyle: ${insights.lifestyle}`);
  if (insights.interests_detected) lines.push('Interests expressed');
  if (insights.strengths_detected) lines.push('Strengths mentioned');
  if (lines.length === 0) return;
  state.notes.push({ phase: phaseLabel, lines });
  $('notes-count').textContent = `${state.notes.length} insight${state.notes.length>1?'s':''}`;
  const tags = [];
  if (insights.work_orientation) insights.work_orientation.forEach(o => tags.push({text:o,cls:'blue'}));
  if (insights.interests_detected) tags.push({text:'üéØ Interests',cls:'green'});
  if (insights.strengths_detected) tags.push({text:'üí™ Strengths',cls:''});
  const card = document.createElement('div');
  card.className = 'note-card';
  card.innerHTML = `
    <div class="note-phase"><span class="note-phase-dot"></span>${phaseLabel}</div>
    <div class="note-label">AI Insight</div>
    <div class="note-value">${lines.join(' ¬∑ ')}</div>
    ${tags.length?`<div class="note-tags">${tags.map(t=>`<span class="note-tag ${t.cls}">${t.text}</span>`).join('')}</div>`:''}`;
  scroll.appendChild(card);
  scroll.scrollTop = scroll.scrollHeight;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GENERATE REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('btn-generate-report').addEventListener('click', async () => {
  showScreen('report');
  const grid = $('report-grid');
  grid.innerHTML = `<div class="report-loading"><div class="spin-ring"></div><span>Generating your personalised career report‚Ä¶</span></div>`;
  try {
    const data = await apiReport(state.messages);
    renderReport(data.report, data.student || state.student);
  } catch(e) {
    grid.innerHTML = `<div class="report-loading">
      <span style="color:#f87171">‚ö† Report failed: ${escHtml(e.message)}</span>
      <button onclick="showScreen('chat')" style="margin-top:12px;padding:8px 18px;background:var(--accent);color:#fff;border:none;border-radius:20px;cursor:pointer;font-size:13px;">‚Üê Back to Chat</button>
    </div>`;
  }
});

function renderReport(rpt, stu) {
  const grid = $('report-grid');
  grid.innerHTML = '';

  const snap = document.createElement('div');
  snap.className = 'report-card';
  snap.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#e9efff">üë§</div>Student Snapshot</div>
    <div class="snapshot-name">${escHtml(stu.name)}</div>
    <div class="snapshot-meta">${escHtml(stu.grade)} ¬∑ ${escHtml(stu.curriculum)}</div>
    <div style="font-size:11.5px;font-weight:600;color:var(--text-sub);margin-bottom:5px;">Top Interests</div>
    <div class="interest-tags">${(rpt.topInterests||[]).map(i=>`<span class="interest-tag">${escHtml(i)}</span>`).join('')}</div>`;
  grid.appendChild(snap);

  const str = document.createElement('div');
  str.className = 'report-card';
  str.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#d1fae5">üí™</div>Key Strengths</div>
    <ul class="strength-list">${(rpt.keyStrengths||[]).map(s=>`<li class="strength-item">${escHtml(s)}</li>`).join('')}</ul>`;
  grid.appendChild(str);

  if (rpt.personalityInsights) {
    const pi = document.createElement('div');
    pi.className = 'report-card full';
    pi.innerHTML = `
      <div class="report-card-title"><div class="icon-sq" style="background:#fce7f3">üß†</div>Personality Insights</div>
      <p style="font-size:13px;color:var(--text-sub);line-height:1.7;">${escHtml(rpt.personalityInsights)}</p>`;
    grid.appendChild(pi);
  }

  const paths = document.createElement('div');
  paths.className = 'report-card full';
  paths.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#ffedd5">üéØ</div>Recommended Career Paths</div>
    ${(rpt.careerPaths||[]).map((cp,i)=>`
      <div class="career-path-card">
        <div class="career-path-header" style="background:${['#f0f4ff','#f0fdf4','#fff7ed'][i]||'#f9fafb'}">
          <div class="career-path-title">${i+1}. ${escHtml(cp.name||'')}</div>
          <span class="career-cluster">${escHtml(cp.cluster||'')}</span>
        </div>
        <div class="career-path-body">
          ${cp.whyItFits?`<p style="font-size:12.5px;color:var(--text-sub);margin-bottom:8px;font-style:italic;">${escHtml(cp.whyItFits)}</p>`:''}
          <ul class="why-list">
            ${(cp.fitReasons||cp.reasons||[]).map(r=>`<li class="why-item"><span class="why-bullet">‚ú¶</span>${escHtml(r)}</li>`).join('')}
          </ul>
          <div class="skill-chips">${(cp.skills||[]).map(s=>`<span class="skill-chip">${escHtml(s)}</span>`).join('')}</div>
          ${cp.applicationHints?`<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-sub);margin-top:12px;margin-bottom:4px;">Application Hints</div>
          <ul class="hint-list">
            ${(cp.applicationHints||[]).map((h,hi)=>`<li class="hint-item"><span class="hint-num">${hi+1}</span>${escHtml(h)}</li>`).join('')}
          </ul>`:''}
        </div>
      </div>`).join('')}`;
  grid.appendChild(paths);

  const next = document.createElement('div');
  next.className = 'report-card full';
  next.innerHTML = `
    <div class="report-card-title"><div class="icon-sq" style="background:#fce7f3">üöÄ</div>Suggested Next Steps</div>
    <ul class="why-list">${(rpt.nextSteps||[]).map(s=>`<li class="why-item"><span class="why-bullet" style="color:var(--accent)">‚Üí</span>${escHtml(s)}</li>`).join('')}</ul>`;
  grid.appendChild(next);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PDF DOWNLOAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('btn-dl-pdf').addEventListener('click', async () => {
  const btn = $('btn-dl-pdf');
  btn.disabled = true;
  btn.textContent = 'Generating‚Ä¶';
  try {
    const blob = await apiReportPDF(state.messages);
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `career_report_${state.student.name.replace(/\s+/g,'_')}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('PDF downloaded!', 'success');
  } catch(e) {
    showToast(`PDF failed: ${e.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Download PDF`;
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEXT INPUT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); }
});
$('chat-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100) + 'px';
});
$('send-btn').addEventListener('click', sendUserMessage);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MISC UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('read-more-toggle').addEventListener('click', () => {
  const list = document.querySelector('.instructions-list');
  const shown = list.style.display !== 'none';
  list.style.display = shown ? 'none' : '';
  $('read-more-toggle').textContent = shown ? 'Read more ‚ñæ' : 'Collapse ‚ñ¥';
});

$('btn-listen-instr').addEventListener('click', () => {
  const text = 'Welcome to Career Discovery AI. Click the microphone button and speak clearly, then click again to stop. Watch the audio level bar to confirm your voice is being picked up. Ivy will guide you through questions about your interests, strengths, and work preferences.';
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.rate = .95;
    window.speechSynthesis.speak(utt);
  }
});
</script>
</body>
</html>
